<!DOCTYPE html>
<html lang="En">
  <head>
    <title>chatbot</title>
  </head>
  <body>
    <div class="js-container"></div>

    <link rel="stylesheet" href="./Styles/chatbot.css" />

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>

    <script type="text/babel">
      //Taking in props from app
      function ChatInput({ chatMessages, setChatMessages }) {
        //the text the user has typed
        const [inputText, setInputText] = React.useState("");
        const [isLoading, setIsLoading] = React.useState(false);

        //saves the words typed in the input element into a variable
        function saveInputText(event) {
          setInputText(event.target.value);
        }

        //sends a message via setChatMessage which is used in ChatMessage component
        async function sendMessage() {
          if (isLoading || inputText === "") {
            return;
          }

          setIsLoading(true);

          const newMessages = [
            ...chatMessages,
            {
              message: inputText,
              sender: "user",
              id: crypto.randomUUID(),
            },
          ];

          setInputText("");

          setChatMessages(newMessages);
          setChatMessages([
            ...newMessages,
            {
              message: (
                <img
                  className="loading-spinner"
                  src="./images/loading-spinner.gif"
                  alt="loading-spinner"
                />
              ),
              sender: "robot",
              id: crypto.randomUUID(),
            },
          ]);

          //This is from an external libary
          const response = await Chatbot.getResponseAsync(inputText);

          const chatbotMessage = {
            message: response,
            sender: "robot",
            id: crypto.randomUUID(),
          };

          setInputText("");

          setChatMessages([...newMessages, chatbotMessage]);

          setIsLoading(false);
        }

        function chatboxKeyboardEvents(event) {
          event.key === "Enter" && sendMessage();
          event.key === "Escape" && setInputText("");
        }

        return (
          <div className="chat-input-container">
            <input
              className="chat-input"
              type="text"
              placeholder="Send a nessage to Chatbot"
              onChange={saveInputText}
              onKeyDown={chatboxKeyboardEvents}
              value={inputText}
              disabled={isLoading}
            />
            <button onClick={sendMessage} className="chat-send-button">
              Send
            </button>
          </div>
        );
      }

      function ChatMessage({ message, sender }) {
        return (
          <>
            <div
              className={sender === "user" ? "user-response" : "robot-response"}
            >
              {sender === "robot" && (
                <img
                  className="user-icon"
                  src="./images/robot.png"
                  alt="profile-picture"
                />
              )}

              <div className="chat-text">{message}</div>

              {sender === "user" && (
                <img
                  className="user-icon"
                  src="./images/user.png"
                  alt="profile-picture"
                />
              )}
            </div>
          </>
        );
      }

      function DefaultChatMessage() {
        return (
          <p onClick>
            Welcome to the chatbot project! Send a message using the textbox
            below.
          </p>
        );
      }

      function ChatMessages({ chatMessages }) {
        const displayedText = DefaultChatMessage();
        const chatLogRef = React.useRef(null);

        React.useEffect(() => {
          const containerElem = chatLogRef.current;
          if (containerElem) {
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        }, [chatMessages]);

        //Looping through messages into seperate componenets
        return (
          <>
            <div className="chat-log" ref={chatLogRef}>
              {chatMessages.map((chatMessage) => {
                return (
                  <ChatMessage
                    key={chatMessage.id}
                    message={chatMessage.message}
                    sender={chatMessage.sender}
                  />
                );
              })}
            </div>
          </>
        );
      }

      function MoveChatbox({ setTextboxPosition, textboxPosition }) {
        function changePosition() {
          setTextboxPosition(!textboxPosition);
        }

        return (
          <p className="move-chatbox-line" onClick={changePosition}>
            Move textbox to top
          </p>
        );
      }

      function App() {
        //Higher state to save the users messages
        const [chatMessages, setChatMessages] = React.useState([]);
        const [textboxPosition, setTextboxPosition] = React.useState(true);

        return (
          <>
            {textboxPosition === true && (
              <ChatInput
                chatMessages={chatMessages}
                setChatMessages={setChatMessages}
              />
            )}
            {chatMessages.length === 0 && (
              <p className="welcome-message">
                Welcome to the chatbot project! Send a message using the textbox
                below.
              </p>
            )}
            <ChatMessages chatMessages={chatMessages} />
            {textboxPosition === false && (
              <ChatInput
                chatMessages={chatMessages}
                setChatMessages={setChatMessages}
              />
            )}
            <MoveChatbox
              textboxPosition={textboxPosition}
              setTextboxPosition={setTextboxPosition}
            />
          </>
        );
      }

      const container = document.querySelector(".js-container");
      ReactDOM.createRoot(container).render(<App />);
    </script>
    <script src="./react-basics.js"></script>
  </body>
</html>
